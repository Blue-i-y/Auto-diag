import os
import requests
import sys
from urllib.parse import urlparse
sys.path.append('../')
import utiles

def is_valid_url(url):
    try:
        result = urlparse(url)
        return all([result.scheme, result.netloc]) and (result.scheme == 'http' or result.scheme == 'https')
    except ValueError:
        return False

def check_subdomains(wordlist, domain):
    try:
        with open(wordlist, 'r') as f:
            sub_list = f.read().splitlines()
    except FileNotFoundError:
        print("Wordlist not found.")
        sys.exit(1)

    # Check if the domain is in the correct format
    if not domain.startswith("http://") and not domain.startswith("https://"):
        print("Invalid domain format. Please enter the domain in the format: http://host/ or https://host/")
        sys.exit(1)

    total_subdomains = len(sub_list)
    tested_subdomains = 0

    for sub in sub_list:
        sub_domain = f"{sub}.{domain.split('://')[1]}"
        tested_subdomains += 1
        completion_percentage = (tested_subdomains / total_subdomains) * 100
        os.system('cls' if os.name == 'nt' else 'clear')
        print(f"Test en cours : {completion_percentage:.2f}%")
        print(f"Sous-domaines test√©s : {sub_domain}\n{tested_subdomains}/{total_subdomains}")
        if not sub or not sub.isalnum(): 
            continue
        if domain.startswith("http://"):
            sub = f"http://{sub}"

        if domain.startswith("https://"):
            sub = f"https://{sub}"


        if not is_valid_url(sub_domain):
            continue

        try:
            response = requests.get(sub_domain)
            if response.status_code == 200:
                print("\rValid domain:", sub_domain)
            elif response.status_code == 403:
                print_orange("\rAccess Forbidden:", sub_domain) 
        except requests.ConnectionError:
            pass

    print()

def main():
    if len(sys.argv) != 2 and len(sys.argv) != 3:
        print("Usage: python SubEnum.py <domain> [<wordlist_file>]")
        sys.exit(1)

    domain = sys.argv[1]

    if len(sys.argv) == 3:
        wordlist = sys.argv[2]
    elif len(sys.argv) == 2:
        wordlist = "/usr/share/wordlists/dirb/common.txt"

    check_subdomains(wordlist, domain)

if __name__ == "__main__":
    main()
